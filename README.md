# aliyun-auto-cert

[![Test](https://github.com/yin1999/aliyun-auto-cert/actions/workflows/test.yml/badge.svg)](https://github.com/yin1999/aliyun-auto-cert/actions/workflows/test.yml)

This is a simple tool to help you fresh your TLS certificate which deployed on Aliyun CDN automatically.

## Usage

Copy the file named [`.env-dist`](.env-dist) to `.env` and edit it, fill in your domain name, email address, and the access key and secret.

```ini
FULL_DOMAIN=domain.example.com
EMAIL=user@example.com
ACCESS_KEY=ak
ACCESS_SECRET=sk
# ACCOUNT FILE could be a json file or an env key (such as `env:ACCOUNT_JSON`)
ACCOUNT_FILE=account.json
MUST_LOAD_ACCOUNT=false # set to true if you do not want to create a new ACME account
```

> [!NOTE]
> The issued access key and secret from Aliyun should be granted with the permission of `AliyunCDNFullAccess` and `AliyunDNSFullAccess`.

Then run the following command to check and renew the certificate:

```bash
# set up the environment variables
export $(grep -v '^#' .env | xargs)

# run the program
./auto-cert
```

### Service Mode

You can also run the program in service mode to check and renew the certificate periodically (with [_systemd_](https://systemd.io/) on Linux).

Create a service file named `aliyun-auto-cert.service` under `/etc/systemd/system/`:

```ini
[Unit]
Description=Auto renew cert
Wants=network-online.target
After=network-online.target

[Service]
EnvironmentFile=/path/to/.env
# Enhance security by using dynamic user account
DynamicUser=yes
ExecStart=/bin/bash -c 'ACCOUNT_FILE="${CREDENTIALS_DIRECTORY}/account.json" /path/to/auto-cert'
LoadCredential=account.json:/path/to/acme-account.json # the acme account file should be generated by the program before setting up this service
Type=simple

[Install]
WantedBy=multi-user.target
```

Then, setup the timer file named `aliyun-auto-cert.timer` under `/etc/systemd/system/`:

```ini
[Unit]
Description=Daily auto-cert

[Timer]
# Start the service after 10 minutes and renew the certificate every day
OnBootSec=10m
OnUnitActiveSec=1d
Persistent=true

[Install]
WantedBy=timers.target
```

Finally, enable and start the timer/service:

```bash
systemctl daemon-reload
systemctl enable --now aliyun-auto-cert.timer
```
